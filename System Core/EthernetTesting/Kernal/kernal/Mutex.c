/******************************************************************************/
/**
 * @file <file-name>.c
 * @brief <file-short-description>
 *
 * @par Project Name
 * <project-name>
 *
 * @par Code Language
 * C
 *
 * @par Description
 * <file-long-description>
 *
 * @par Author
 * <author-name>
 *
 */
/******************************************************************************/

/******************************************************************************/
/* INCLUDES */
/******************************************************************************/
#include "inc/SquadRTOS.h"

/******************************************************************************/

/******************************************************************************/
/* PRIVATE DEFINES */
/******************************************************************************/

/******************************************************************************/

/******************************************************************************/
/* PRIVATE MACROS */
/******************************************************************************/

/******************************************************************************/

/******************************************************************************/
/* PRIVATE ENUMS */
/******************************************************************************/

/******************************************************************************/

/******************************************************************************/
/* PRIVATE TYPES */
/******************************************************************************/

/******************************************************************************/

/******************************************************************************/
/* PRIVATE CONSTANT DEFINITIONS */
/******************************************************************************/

/******************************************************************************/

/******************************************************************************/
/* PRIVATE VARIABLE DEFINITIONS */
/******************************************************************************/

/******************************************************************************/

/******************************************************************************/
/* PUBLIC CONSTANT DEFINITIONS */
/******************************************************************************/

/******************************************************************************/

/******************************************************************************/
/* PUBLIC VARIABLE DEFINITIONS */
/******************************************************************************/

/******************************************************************************/

/******************************************************************************/
/* PRIVATE FUNCTION PROTOTYPES */
/******************************************************************************/

/******************************************************************************/

/******************************************************************************/
/* PRIVATE FUNCTION DEFINITIONS */
/******************************************************************************/

/******************************************************************************/

/******************************************************************************/
/* PUBLIC FUNCTION DEFINITIONS */
/******************************************************************************/
void SquadRTOS_vCreateMutex(SquadRTOS_tstMutex * pstMutex , uint32_t u32InitialValue)
{
    ASSERT(pstMutex != NULL);
    ASSERT((u32InitialValue == 0) || (u32InitialValue == 1));
    SquadRTOS_vListInit(&pstMutex->NeedAccesThisMutex);
    pstMutex->bKey = u32InitialValue;

}

uint32_t SquadRTOS_vTakeMutex(SquadRTOS_tstMutex * pstMutex , uint32_t u32WaitFlag)
{
    ASSERT(pstMutex != NULL);
    ASSERT((u32WaitFlag == 1) || (u32WaitFlag == 0));
    uint32_t u32ReturnState = 0;
    uint32_t u32Terminate   = 0;
    SquadRTOS_tstThread * pstCurrentThread  = SquadRTOS_ThreadGetRunning();
    while(1 !=u32Terminate)
    {
        if(1 == __LDREXW(&pstMutex->bKey))
        {
            if(0 == __STREXW(0, &pstMutex->bKey))
            {
                __DMB();
                u32ReturnState = 1;
                u32Terminate   = 1;
            }
        }
        else
        {
            u32Terminate = 1;
        }
    }
    if(u32WaitFlag == 1 && u32ReturnState == 0)
    {
        SquadRTOS_vListRemove(&pstCurrentThread->genericListItem);
        SquadRTOS_vListInsert(&pstMutex->NeedAccesThisMutex, &pstCurrentThread->genericListItem);
        SCB->ICSR |= SCB_ICSR_PENDSVSET_Msk;
        u32ReturnState = 2;
    }
    return u32ReturnState;
}

void SquadRTOS_vReleaseMutex(SquadRTOS_tstMutex * pstMutex)
{
    ASSERT(pstMutex != NULL);
    SquadRTOS_tstThread * pstThread ;
    __DMB();
    pstMutex->bKey = 1;
    if(pstMutex->NeedAccesThisMutex.u32ElmentsNum > 0)
    {
           pstThread = pstMutex->NeedAccesThisMutex.stDummy.pstNext->pvThraed;
           ASSERT(pstThread != NULL);
           SquadRTOS_vListRemove(&pstThread->genericListItem);
           SquadRTOS_vThreadAddToReadyList(pstThread);
    }

}
/******************************************************************************/
